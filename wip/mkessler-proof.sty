\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{mkessler-proof}

%%%% This package will be developed for proofs with automatic references to theorems
% for claims numbered within these profos
% and for nice subproof  / proof of claim environments

\newif\ifmkessler@proof@english\mkessler@proof@englishtrue
\DeclareOption{german}{\mkessler@proof@englishfalse}

\DeclareOption*{\PackageWarning{mkessler-proof}{Unknown '\CurrentOption'}}
\ProcessOptions\relax

\RequirePackage{amssymb}
\RequirePackage{amsthm}
\RequirePackage{etoolbox}
\RequirePackage{xparse}

%%Give claim an own counter and let it reset at each proof
%See also at:
%https://tex.stackexchange.com/questions/283502/reset-counter-at-beginning-of-proof
\newtheorem{claim}{\ifmkessler@proof@english Claim\else Behauptung\fi}
\newtheorem*{claim*}{\ifmkessler@proof@english Claim\else Behauptung\fi}
\AtBeginDocument{\def\claimautorefname{\ifmkessler@proof@english Claim\else Behauptung\fi}}

\newif\ifhyperref
\AtBeginDocument{
    \@ifpackageloaded{hyperref}{
        \hyperreftrue
        \def\grab#1{\expandafter\@firstoffive#1}
        \def\mkessler@proof@blankref#1{\expandafter\grab\csname r@#1\endcsname}
        \let\mkessler@proof@autoref\autoref
    }{
        \hyperreffalse
        \let\mkessler@proof@blankref\ref
        \let\mkessler@proof@autoref\ref
    }
}

\NewDocumentEnvironment{rproof}{m O{}}{\def\mkessler@proof@aster{\relax}\begin{mkessler@fancythm@rproof@impl}{#1}[#2]}{\end{mkessler@fancythm@rproof@impl}}
\NewDocumentEnvironment{rproof*}{m O{}}{\def\mkessler@proof@aster{*}\begin{mkessler@fancythm@rproof@impl}{#1}[#2]}{\end{mkessler@fancythm@rproof@impl}}

\NewDocumentEnvironment{mkessler@fancythm@rproof@impl}{m O{}}
{
    % Restore correct counter for claim
    \ifcsdef{themkessler@proof@#1@save@claim}{
        \setcounter{claim}{\value{mkessler@proof@#1@save@claim}}
        \def\mkessler@proof@proofprefix{\ifmkessler@proof@english Continuation of proof\mkessler@proof@aster\space of\else Fortsetzung des Beweises\mkessler@proof@aster\space zu\fi}
        \edef\haha{\value{mkessler@proof@#1@part}}
    }{
        \newcounter{mkessler@proof@#1@save@claim}
        \setcounter{claim}{0}
        \def\mkessler@proof@proofprefix{\ifmkessler@proof@english Proof\mkessler@proof@aster\space of\else Beweis\mkessler@proof@aster\space von\fi}
    }
    % Set up counter number printing as subindexed by numbering of the reference
    \let\mkessler@proof@theoldclaim\theclaim
    \def\theclaim{\mkessler@proof@blankref{#1}.\mkessler@proof@theoldclaim}
    % Now, start the actual proof
    \begin{proof}[\mkessler@proof@proofprefix\space\mkessler@proof@autoref{#1}\if\relax\detokenize{#2}\relax\else\space(#2)\fi]
}
{
    \end{proof} % End proof
    % Save current claim counter for later restoration
    \setcounter{mkessler@proof@#1@save@claim}{\value{claim}}
}

%%subproof environment - essentially copied proof environment from amsthm and modified its name + symbol
\DeclareRobustCommand{\blackqed}{%
  \ifmmode \mathqed
  \else
    \leavevmode\unskip\penalty9999 \hbox{}\nobreak\hfill
    \quad\hbox{$\blacksquare$}%
  \fi
}

\newenvironment{subproof}[1][\ifmkessler@proof@english Subproof\else Unterbeweis\fi]{\par
  \pushQED{\blackqed}%
  \normalfont \topsep6\p@\@plus6\p@\relax
  \trivlist
  \item[\hskip\labelsep
        \itshape
    #1\@addpunct{.}]\ignorespaces
}{%
  \popQED\endtrivlist\@endpefalse
}


%%%% This might be dropped, but for now is collected here

%%Solution (for exercises)
\newenvironment{solution}[1][]{\begin{proof}[\ifmkessler@proof@english{}Solution\else{}LÃ¶sung\fi{}#1]}{\end{proof}}

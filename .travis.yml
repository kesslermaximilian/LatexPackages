sudo: true
dist: bionic
language: python
cache: apt

addons:
  apt:
    packages:
      - tree
      - latexmk
      - biber
      - make

install:
    - pip install GitPython
      
script:
    - GIT_BRANCH=$(python3 -c "import git; print(git.Repo().active_branch.name)")
    - python3 -c 'from build import build; build("build/LatexPackages/")'
    - cd build
    - zip -r LatexPackages.zip LatexPackages
    - tree -H '.' -I "index.html" -D --charset utf-8 -T "LatexPackages" > index.html

deploy:
    - provider: pages
      skip-cleanup: true
      github-token: $GITHUB_TOKEN
      local-dir: build/
      keep-history: false
      on:
        branch: master
    - provider: releases
      api_key: $GITHUB_TOKEN
      skip_cleanup: true
      file: $TRAVIS_BUILD_DIR/build/LatexPackages.zip
      on:
          tags: true
    - provider: pages
      skip-cleanup: true
      github-token: $GITHUB_TOKEN
      local-dir: build/LatexPackages
      repo: kesslermaximilian/LatexPackagesBuild
      commiter_from_gh: true
      allow_empty_commit: true
      keep-history: true
      target_branch: $GIT_BRANCH
      on:
          branches:
              only:
                  - /.*/
